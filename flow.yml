jtype: Flow
with:
  protocol: grpc
  port: 51005
  monitoring: true  # enable prometheus & grafana
  port_monitoring: 51006
  env:
    JINA_LOG_LEVEL: debug
executors:
  - name: dalle
    uses: jinahub+docker://DalleGenerator
    port_monitoring: 51007
    timeout_ready: -1  # slow download speed often leads to timeout
    replicas: 2
    # env:
    #   CUDA_VISIBLE_DEVICES: 0  # change this if you have multiple GPU
    # gpus: all
    volumes:
      - $HOME/.cache:/root/.cache
      # - $HOME/.cache:/home/dalle/.cache
    jcloud:
      resources:
        memory: 10G
        gpu: shared
  - name: clip_encoder
    uses: jinahub+docker://CLIPTorchEncoder/latest
    host: 'demo-cas.jina.ai'
    port: 2096
    tls: true
    external: true
    needs: [gateway]
  - name: diffusion
    uses: jinahub+docker://GLID3Diffusion
    port_monitoring: 51008
    timeout_ready: -1  # slow download speed often leads to timeout
    # env:
    #   CUDA_VISIBLE_DEVICES: 0  # change this if you have multiple GPU
    replicas: 2
    needs: [clip_encoder]
    # gpus: all
    volumes:
      - $HOME/.cache:/root/.cache
      # - $HOME/.cache:/home/dalle/.cache
    jcloud:
      resources:
        memory: 10G
        gpu: shared
  - name: rerank
    port_monitoring: 51009
    uses: jinahub+docker://CLIPTorchEncoder/latest
    host: 'demo-cas.jina.ai'
    port: 2096
    uses_requests:
      '/': rank
    tls: true
    external: true
    needs: [dalle, diffusion]
    replicas: 2
  - name: upscaler
    uses: jinahub+docker://SwinIRUpscaler
    port_monitoring: 51010
    replicas: 2
    # env:
    #   CUDA_VISIBLE_DEVICES: 0  # change this if you have multiple GPU
    jcloud:
      resources:
        memory: 5G
        gpu: shared
  - name: store
    uses: jinahub+docker://DalleStore
    port_monitoring: 51011
    replicas: 2
    jcloud:
      resources:
        memory: 500M
